<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MIOS</title>
    <style>
        :root {
            --bg: #0f1115;
            --panel: #151923;
            --panel-2: #1b2030;
            --text: #e7eaf0;
            --muted: #9aa3b2;
            --accent: #5b9cff;
            --accent-2: #7dd3fc;
            --danger: #ef4444;
            --ok: #22c55e;
            --warn: #f59e0b;
            --shadow: 0 8px 30px rgba(0,0,0,.35);
            --radius: 14px;
        }

        .light-theme {
            --bg: #f5f5f5;
            --panel: #ffffff;
            --panel-2: #f0f0f0;
            --text: #333;
            --muted: #666;
            --accent: #007bff;
            --accent-2: #4fc3f7;
            --danger: #d32f2f;
            --ok: #43a047;
            --warn: #ffa000;
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
            color: var(--text);
            background: var(--bg);
            transition: background 0.3s ease;
            overflow: hidden;
            user-select: none;
        }

        .desktop {
            position: fixed;
            inset: 0 0 48px 0;
            padding: 24px;
            backdrop-filter: saturate(120%);
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease;
        }

        #login-screen {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            backdrop-filter: blur(20px);
            z-index: 10000;
            transition: opacity .3s ease;
        }
        #login-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .login-box {
            width: 340px;
            padding: 30px;
            background: linear-gradient(180deg, var(--panel), var(--panel-2));
            border: 1px solid rgba(255,255,255,.08);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            color: var(--text);
        }
        .login-box h2 {
            margin: 0 0 20px;
            text-align: center;
            font-weight: 700;
        }
        #login-error {
            color: var(--danger);
            font-size: .9rem;
            text-align: center;
            margin-top: 12px;
            min-height: 1.2em;
        }
        #loginForm button {
            width: 100%;
            margin-top: 10px;
            justify-content: center;
        }

        .desktop, .taskbar {
            visibility: hidden;
            opacity: 0;
            transition: opacity .3s ease;
        }
        .desktop.visible, .taskbar.visible {
            visibility: visible;
            opacity: 1;
        }

        .taskbar {
            position: fixed;
            left: 0; right: 0; bottom: 0;
            height: 48px;
            background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
            border-top: 1px solid rgba(255,255,255,.06);
            display: grid;
            grid-template-columns: 220px 1fr 220px;
            align-items: center;
            padding: 0 10px;
            gap: 10px;
            backdrop-filter: blur(10px);
        }
        .tb-left, .tb-center, .tb-right { display: flex; align-items: center; gap: 8px; }

        .btn {
            display: inline-flex; align-items: center; gap: 8px;
            border: 1px solid rgba(255,255,255,.08);
            background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
            color: var(--text);
            height: 34px; padding: 0 12px; border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 1px 0 rgba(255,255,255,.05) inset;
            transition: transform .06s ease, background .2s ease, border-color .2s ease;
        }
        .btn:hover { border-color: rgba(255,255,255,.16); }
        .btn:active { transform: translateY(1px); }
        .btn.small { height: 28px; padding: 0 10px; border-radius: 8px; }
        .btn.ghost { background: transparent; border-color: transparent; }
        .btn.install { background-color: var(--ok); border-color: var(--ok); color: #fff; }

        .start { font-weight: 700; letter-spacing: .2px; }

        .apps-area { display: flex; align-items: center; gap: 6px; height: 100%; overflow-x: auto; scrollbar-width: thin; padding: 4px 0; }

        .task { min-width: 120px; max-width: 220px; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .task.active { outline: 2px solid rgba(91,156,255,.12); }

        .clock { margin-left: auto; opacity: .9; font-variant-numeric: tabular-nums; }

        .start-menu { 
            position: fixed; left: 10px; bottom: 58px; width: 360px; max-width: calc(100% - 20px); background: linear-gradient(180deg, var(--panel), var(--panel-2)); border: 1px solid rgba(255,255,255,.08); border-radius: var(--radius); box-shadow: var(--shadow); padding: 12px; display: none; animation: pop .12s ease;
            color: var(--text);
            z-index: 9999;
        }
        .start-menu.active { display: block; }
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 12px;
            background: rgba(255,255,255,0.04);
        }
        .user-info svg {
            width: 24px;
            height: 24px;
            opacity: 0.8;
        }
        .username-display {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text);
        }

        .menu-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 12px; cursor: pointer; transition: background .15s ease; }
        .menu-item:hover { background: rgba(255,255,255,.06); }
        .menu-item .title { font-weight: 600; }
        .menu-item .desc { color: var(--muted); font-size: .9rem; }
        
        .start-menu .divider { height: 1px; background: rgba(255,255,255,.1); margin: 8px 0; }
        
        .window { 
            position: absolute; min-width: 520px; max-width: 860px; width: 720px; min-height: 300px; background: linear-gradient(180deg, var(--panel), var(--panel-2)); border: 1px solid rgba(255,255,255,.08); border-radius: var(--radius); box-shadow: var(--shadow); overflow: clip; display: none;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, width 0.3s ease, height 0.3s ease, left 0.3s ease, top 0.3s ease;
        }
        .window.active { display: block; }
        .window.minimized {
            transform: scale(0.9) translateY(20px);
            opacity: 0;
            pointer-events: none;
        }

        .titlebar { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: rgba(255,255,255,.04); border-bottom: 1px solid rgba(255,255,255,.06); cursor: move; }
        .titlebar .title { font-weight: 700; letter-spacing: .2px; }
        .titlebar .actions { margin-left: auto; display: flex; gap: 6px; }
        .icon { width: 18px; height: 18px; opacity: .95; }

        .content { padding: 16px; user-select: text; }

        .tabs { display: flex; gap: 8px; margin-bottom: 12px; }
        .tab { padding: 8px 12px; border-radius: 10px; background: rgba(255,255,255,.05); cursor: pointer; }
        .tab.active { outline: 2px solid rgba(91,156,255,.35); background: rgba(91,156,255,.12); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .grid { display: grid; gap: 12px; }
        .grid.cols-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }

        .card { background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.06); border-radius: 12px; padding: 14px; }
        .card h3 { margin: 0 0 8px; font-size: 1rem; }
        .muted { color: var(--muted); font-size: .92rem; }

        label { display: block; font-size: .92rem; margin-bottom: 6px; color: var(--muted); }
        input[type="text"], input[type="password"], input[type="number"], select { width: 100%; height: 36px; padding: 0 10px; border-radius: 10px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); color: var(--text); }
        textarea { width: 100%; min-height: 110px; padding: 10px; border-radius: 12px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); color: var(--text); resize: vertical; }
        .row { display: flex; gap: 8px; align-items: center; }
        .row > * { flex: 1; }

        .stat { font-weight: 800; font-size: 1.6rem; letter-spacing: .3px; }
        .pill { font-size: .8rem; padding: 4px 8px; border-radius: 999px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.1); }

        .toast { position: fixed; right: 12px; bottom: 60px; padding: 10px 14px; border-radius: 10px; background: #101418; border: 1px solid rgba(255,255,255,.1); display: none; }
        .toast.show { display: block; animation: fade .18s ease; }
        
        .cmd-content {
            background: #0a0c10;
            height: 320px;
            padding: 10px;
            font-family: Consolas, 'Courier New', monospace;
            font-size: .95rem;
            overflow-y: auto;
            border-radius: 0 0 var(--radius) var(--radius);
        }
        .cmd-output { white-space: pre-wrap; }
        .cmd-line { display: flex; }
        .cmd-prompt { flex-shrink: 0; }
        .cmd-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text);
            font-family: inherit;
            font-size: inherit;
            padding: 0 0 0 5px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .file-item:hover {
            background: rgba(255,255,255,0.05);
        }
        .file-item.folder .icon {
            color: #ffc107;
        }
        .file-item.file .icon {
            color: var(--muted);
        }

        .resize-handle {
            position: absolute;
            z-index: 100;
            background: transparent;
        }
        .resize-handle.top, .resize-handle.bottom {
            left: 10px; right: 10px; height: 10px; cursor: ns-resize;
        }
        .resize-handle.left, .resize-handle.right {
            top: 10px; bottom: 10px; width: 10px; cursor: ew-resize;
        }
        .resize-handle.corner {
            width: 20px; height: 20px; z-index: 101;
        }
        .resize-handle.top { top: 0; }
        .resize-handle.bottom { bottom: 0; }
        .resize-handle.left { left: 0; }
        .resize-handle.right { right: 0; }
        .resize-handle.top-left { top: 0; left: 0; cursor: nwse-resize; }
        .resize-handle.top-right { top: 0; right: 0; cursor: nesw-resize; }
        .resize-handle.bottom-left { bottom: 0; left: 0; cursor: nesw-resize; }
        .resize-handle.bottom-right { bottom: 0; right: 0; cursor: nwse-resize; }

        /* Gaya untuk layar shutdown */
        #shutdown-screen {
            position: fixed;
            inset: 0;
            z-index: 10001;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
            text-align: center;
            color: var(--text);
        }
        #shutdown-screen.active {
            display: flex;
        }
        .shutdown-content {
            padding: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            max-width: 400px;
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .shutdown-content h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        .shutdown-input-group {
            margin-top: 15px;
            width: 100%;
        }
        .shutdown-input-group input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text);
            text-align: center;
        }
        .countdown-text {
            font-size: 4rem;
            font-weight: 700;
            margin-top: 20px;
            transition: color 0.3s ease, background-color 0.3s ease;
            padding: 10px 20px;
            border-radius: 10px;
        }
        .countdown-text.green { background: #22c55e; color: #fff; }
        .countdown-text.yellow { background: #f59e0b; color: #fff; }
        .countdown-text.red { background: #ef4444; color: #fff; }
        .final-message {
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: 2px;
            color: #fff;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        /* Konteks Menu */
        .context-menu {
            position: absolute;
            background: var(--panel);
            border: 1px solid rgba(255,255,255,.1);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 8px;
            display: none;
            z-index: 1000;
        }
        .context-menu.active {
            display: block;
            animation: pop .1s ease;
        }
        .context-item {
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: background .15s ease;
            white-space: nowrap;
        }
        .context-item:hover {
            background: rgba(255,255,255,.06);
        }
        
        .app-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 12px;
            background: rgba(255,255,255,0.04);
        }

        /* Gaya Khusus Ebytor */
        .ebytor-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .editor-area {
            display: flex;
            gap: 12px;
        }
        .editor-area .card {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 400px; /* Atau sesuaikan tinggi */
        }
        .editor-area textarea {
            flex: 1;
            background: #0a0c10;
            border: none;
            font-family: monospace;
            font-size: 0.9em;
            resize: none;
        }
        .editor-area iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #fff;
        }

        /* Gaya Modal Baru */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal {
            background: var(--panel);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal {
            transform: translateY(0);
        }
        .modal h3 { margin-top: 0; }

        @keyframes pop { from { transform: translateY(8px) scale(.98); opacity: 0 } to { transform: none; opacity: 1 } }
        @keyframes fade { from { opacity: 0 } to { opacity: 1 } }

        @media (max-width: 760px){ .window { width: calc(100% - 24px); left: 12px !important; right: 12px !important; min-width: auto; } .grid.cols-2 { grid-template-columns: 1fr; } .desktop { padding: 12px; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>Selamat Datang di MIOS</h2>
            <form id="loginForm">
                <label for="username">Username</label>
                <input type="text" id="username" value="admin" required />
                <label for="password" style="margin-top: 8px;">Password</label>
                <input type="password" id="password" value="1234" required />
                <div id="login-error"></div>
                <button type="submit" class="btn">Login</button>
            </form>
        </div>
    </div>

    <div class="desktop" id="desktop"></div>

    <div class="start-menu" id="startMenu">
        <div class="user-info">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 00-4-4H9a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <div class="username-display" id="usernameDisplay"></div>
        </div>
        <div class="divider"></div>
        <div class="menu-item" id="openAdminFromMenu">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1l3 5 5 .5-3.6 3.4.9 5-5.3-2.7-5.3 2.7.9-5L4 6.5 9 6z"/></svg>
            <div><div class="title">Admin Panel</div><div class="desc">Kelola pengguna, log, dan pengaturan</div></div>
        </div>
        <div class="menu-item" id="openCmd">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 17l6-6-6-6"/><path d="M12 19h8"/></svg>
            <div><div class="title">Command Prompt</div><div class="desc">Jalankan perintah sistem</div></div>
        </div>
        <div class="menu-item" id="openExplorer">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h18v13H3z"/><path d="M3 7L6 4h6l3 3"/></svg>
            <div><div class="title">File Explorer</div><div class="desc">Jelajahi file demo</div></div>
        </div>
        <div class="divider"></div>
        <div class="menu-item" id="openMines">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M2 12h2"/><path d="M20 12h2"/></svg>
            <div><div class="title">Minesweeper</div><div class="desc">Mini game</div></div>
        </div>
        <div class="menu-item" id="openTetris">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="6" height="6"/><rect x="15" y="3" width="6" height="6"/><rect x="3" y="15" width="6" height="6"/><rect x="15" y="15" width="6" height="6"/></svg>
            <div><div class="title">Tetris</div><div class="desc">Mini game</div></div>
        </div>
        <div class="divider"></div>
        <div class="menu-item" id="openStoreFromMenu">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 100 20 10 10 0 000-20z"/><path d="M12 6v12M16 12H8"/></svg>
            <div><div class="title">App Store</div><div class="desc">Instal aplikasi baru</div></div>
        </div>
        <div id="installedAppsMenu">
            </div>
        <div class="menu-item" id="aboutBtn">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8h.01"/><path d="M11 12h1v4h1"/></svg>
            <div><div class="title">Tentang MIOS</div><div class="desc">Demo UI Taskbar + Admin Panel</div></div>
        </div>
        <div class="divider"></div>
        <div class="menu-item" id="logoutBtn">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><path d="M16 17l5-5-5-5"/><path d="M21 12H9"/></svg>
            <div><div class="title">Logout</div><div class="desc">Keluar dari sesi ini</div></div>
        </div>
        <div class="menu-item" id="shutdownBtn">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v10"/><path d="M18.36 17.5A9 0 1112 2.5a9 0 016.36 15z"/></svg>
            <div><div class="title">Shutdown Server</div><div class="desc">Matikan server secara permanen</div></div>
        </div>
    </div>

    <div class="context-menu" id="desktopContextMenu">
        <div class="context-item" id="createTxtFile">Create new Text file</div>
        <div class="context-item" id="deleteFile">Delete this file</div>
    </div>

    <div class="window" id="adminWindow" data-title="Admin Panel" style="left: 80px; top: 80px; width: 860px; min-width: 520px; max-width: 90vw;">
        <div class="titlebar" data-drag>
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h18v14H3z"/><path d="M7 21h10"/></svg>
            <div class="title">Admin Panel</div>
            <div class="pill" id="rolePill">role: admin</div>
            <div class="actions"><button class="btn small ghost" data-minimize title="Minimize">—</button><button class="btn small ghost" data-maximize title="Maximize">◻</button><button class="btn small ghost" data-close title="Close">✕</button></div>
        </div>
        <div class="content">
            <div class="tabs"><div class="tab active" data-tab="dash">Dashboard</div><div class="tab" data-tab="users">Users</div><div class="tab" data-tab="settings">Settings</div><div class="tab" data-tab="logs">Logs</div></div>

            <div class="tab-panel active" id="tab-dash">
                <div class="grid cols-2">
                    <div class="card"><h3>Status Server</h3><div class="muted">Uptime</div><div class="stat" id="uptime">00:00:00</div><div class="row"><span class="pill">CPU: <span id="cpu">7%</span></span><span class="pill">RAM: <span id="ram">35%</span></span><span class="pill">Users: <span id="usersOnline">2</span></span></div></div>
                    <div class="card"><h3>Aksi Cepat</h3><div class="row"><button class="btn" id="btnRestart">Restart Service</button><button class="btn" id="btnClearCache">Clear Cache</button></div><p class="muted" style="margin-top:8px">Aksi ini hanya simulasi untuk demo.</p></div>
                    <div class="card"><h3>Info</h3><p class="muted">Ini adalah demo Admin Panel berbasis HTML/CSS/JS.</p></div>
                    <div class="card"><h3>Notifikasi</h3><div id="notifArea" class="muted">Belum ada notifikasi.</div></div>
                </div>
            </div>
            <div class="tab-panel" id="tab-users"><div class="grid cols-2"><div class="card"><h3>Tambah Pengguna</h3><label>Username</label><input type="text" id="newUser" placeholder="mis. alice" /><div class="row" style="margin-top:8px"><button class="btn" id="addUser">Tambah</button><button class="btn" id="clearUsers">Kosongkan</button></div></div><div class="card"><h3>Daftar Pengguna</h3><div id="userList" class="muted">(kosong)</div></div></div></div>
            <div class="tab-panel" id="tab-settings"><div class="grid cols-2"><div class="card"><h3>Umum</h3><label>Nama Situs</label><input type="text" id="siteName" placeholder="My Awesome App" /><label style="margin-top:8px">Tema</label><select id="themeSelect"><option value="dark" selected>Dark</option><option value="light">Light</option><option value="amoled">AMOLED</option></select><label style="margin-top:8px">Wallpaper</label><select id="wallpaperSelect"><option value="default" selected>Default</option><option value="nature">Nature</option><option value="abstract">Abstract</option></select><label style="margin-top:8px">Format Waktu</label><select id="timeFormatSelect"><option value="24h" selected>24 Jam</option><option value="12h">12 Jam</option></select></div><div class="card"><h3>Keamanan</h3><label>Password Admin</label><input type="password" id="adminPass" placeholder="••••••" /><div class="row" style="margin-top:8px"><button class="btn" id="saveSettings">Simpan</button><button class="btn" id="resetSettings">Reset</button></div></div></div></div>
            <div class="tab-panel" id="tab-logs"><div class="card"><h3>Activity Logs</h3><textarea id="logs" readonly>[boot] system ready\n</textarea></div></div>
        </div>
        <div class="resize-handle top"></div>
        <div class="resize-handle bottom"></div>
        <div class="resize-handle left"></div>
        <div class="resize-handle right"></div>
        <div class="resize-handle top-left"></div>
        <div class="resize-handle top-right"></div>
        <div class="resize-handle bottom-left"></div>
        <div class="resize-handle bottom-right"></div>
    </div>

    <div class="window" id="cmdWindow" data-title="Command Prompt" style="left: 150px; top: 150px; width: 640px; min-height: 200px; max-width: 90vw;">
        <div class="titlebar" data-drag>
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 17l6-6-6-6"/><path d="M12 19h8"/></svg>
            <div class="title">Command Prompt</div>
            <div class="actions"><button class="btn small ghost" data-minimize title="Minimize">—</button><button class="btn small ghost" data-maximize title="Maximize">◻</button><button class="btn small ghost" data-close title="Close">✕</button></div>
        </div>
        <div class="content cmd-content" id="cmdContent">
            <div class="cmd-output" id="cmdOutput">MIOS [Version 1.0.0]\n(c) 2025 MIOS Corp. All rights reserved.\n\n</div>
            <div class="cmd-line">
                <span class="cmd-prompt" id="cmdPrompt">C:\Users\Admin></span>
                <input type="text" class="cmd-input" id="cmdInput" autofocus autocomplete="off" />
            </div>
        </div>
        <div class="resize-handle top"></div>
        <div class="resize-handle bottom"></div>
        <div class="resize-handle left"></div>
        <div class="resize-handle right"></div>
        <div class="resize-handle top-left"></div>
        <div class="resize-handle top-right"></div>
        <div class="resize-handle bottom-left"></div>
        <div class="resize-handle bottom-right"></div>
    </div>

    <div class="window" id="explorerWindow" data-title="File Explorer" style="left: 120px; top: 120px; width: 760px; min-width: 420px; max-width: 90vw;">
        <div class="titlebar" data-drag><div class="title">File Explorer</div><div class="actions"><button class="btn small ghost" data-minimize title="Minimize">—</button><button class="btn small ghost" data-maximize title="Maximize">◻</button><button class="btn small ghost" data-close title="Close">✕</button></div></div>
        <div class="content" style="display:flex; gap:12px;"><div style="width:260px;"><div class="card" style="height:100%;"><h3>Folders</h3><div id="folderList" class="muted"></div></div></div><div style="flex:1;"><div class="card" style="height:100%; display:flex; flex-direction:column;"><h3>File Preview</h3><div id="filePreview" style="flex:1; overflow:auto; padding:8px; background:rgba(0,0,0,0.03); border-radius:8px;">Pilih file untuk melihat isinya.</div></div></div></div>
        <div class="resize-handle top"></div>
        <div class="resize-handle bottom"></div>
        <div class="resize-handle left"></div>
        <div class="resize-handle right"></div>
        <div class="resize-handle top-left"></div>
        <div class="resize-handle top-right"></div>
        <div class="resize-handle bottom-left"></div>
        <div class="resize-handle bottom-right"></div>
    </div>
    
    <div class="window" id="minesWindow" data-title="Minesweeper" style="left: 200px; top: 140px; width: 420px; min-width: 320px; max-width: 90vw;">
        <div class="titlebar" data-drag><div class="title">Minesweeper</div><div class="actions"><button class="btn small ghost" data-minimize title="Minimize">—</button><button class="btn small ghost" data-maximize title="Maximize">◻</button><button class="btn small ghost" data-close title="Close">✕</button></div></div>
        <div class="content"><div class="row" style="margin-bottom:8px"><button class="btn" id="restartMines">Restart</button><div class="muted" id="minesStatus">Ready</div></div><div id="minesBoard" style="display:grid; grid-template-columns: repeat(9, 1fr); gap:4px; max-width:360px;"></div></div>
        <div class="resize-handle top"></div>
        <div class="resize-handle bottom"></div>
        <div class="resize-handle left"></div>
        <div class="resize-handle right"></div>
        <div class="resize-handle top-left"></div>
        <div class="resize-handle top-right"></div>
        <div class="resize-handle bottom-left"></div>
        <div class="resize-handle bottom-right"></div>
    </div>

    <div class="window" id="tetrisWindow" data-title="Tetris" style="left: 260px; top: 160px; width: 360px; min-width: 280px; max-width: 90vw;">
        <div class="titlebar" data-drag><div class="title">Tetris</div><div class="actions"><button class="btn small ghost" data-minimize title="Minimize">—</button><button class="btn small ghost" data-maximize title="Maximize">◻</button><button class="btn small ghost" data-close title="Close">✕</button></div></div>
        <div class="content" style="display:flex; flex-direction:column; align-items:center; gap:8px;"><canvas id="tetrisCanvas" width="200" height="400" style="background: rgba(255,255,255,.02); border-radius:8px;"></canvas><div class="row" style="width:100%"><button class="btn" id="restartTetris">Restart</button><div class="muted" id="tetrisStatus">Ready</div></div></div>
        <div class="resize-handle top"></div>
        <div class="resize-handle bottom"></div>
        <div class="resize-handle left"></div>
        <div class="resize-handle right"></div>
        <div class="resize-handle top-left"></div>
        <div class="resize-handle top-right"></div>
        <div class="resize-handle bottom-left"></div>
        <div class="resize-handle bottom-right"></div>
    </div>

    <div class="window" id="clockWindow" data-title="Clock" style="left: 300px; top: 200px; width: 320px; max-width: 90vw; min-height: auto;">
        <div class="titlebar" data-drag><div class="title">Clock</div><div class="actions"><button class="btn small ghost" data-minimize title="Minimize">—</button><button class="btn small ghost" data-close title="Close">✕</button></div></div>
        <div class="content" style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
            <h3>Jam Analog</h3>
            <canvas id="analogClockCanvas" width="200" height="200"></canvas>
            <div class="divider" style="width: 100%;"></div>
            <h3>Timer</h3>
            <div style="font-size: 2rem; font-weight: bold;" id="timerDisplay">00:00</div>
            <div class="row" style="width: 100%;">
                <button class="btn" id="timerStart">Start</button>
                <button class="btn" id="timerPause" style="display: none;">Pause</button>
                <button class="btn" id="timerReset">Reset</button>
            </div>
            <input type="number" id="timerInput" placeholder="Detik" style="width: 100%; margin-top: 10px;">
        </div>
        <div class="resize-handle top"></div>
        <div class="resize-handle bottom"></div>
        <div class="resize-handle left"></div>
        <div class="resize-handle right"></div>
        <div class="resize-handle top-left"></div>
        <div class="resize-handle top-right"></div>
        <div class="resize-handle bottom-left"></div>
        <div class="resize-handle bottom-right"></div>
    </div>

    <div class="window" id="displayerWindow" data-title="Displayer" style="left: 280px; top: 180px; width: 680px; min-width: 480px; max-width: 90vw;">
        <div class="titlebar" data-drag><div class="title">Displayer</div><div class="actions"><button class="btn small ghost" data-minimize title="Minimize">—</button><button class="btn small ghost" data-maximize title="Maximize">◻</button><button class="btn small ghost" data-close title="Close">✕</button></div></div>
        <div class="content" style="display:flex; flex-direction: column; gap:12px;">
            <div id="mediaViewer" style="height: 360px; display: flex; justify-content: center; align-items: center; background: rgba(255,255,255,.05); border-radius:12px; overflow: hidden; position: relative;">
                <p class="muted">Pilih file media dari daftar di bawah.</p>
            </div>
            <div class="card" style="flex:1;">
                <h3>Pilih File</h3>
                <div id="mediaFileList" style="max-height: 180px; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 8px;">
                    </div>
            </div>
        </div>
        <div class="resize-handle top"></div>
        <div class="resize-handle bottom"></div>
        <div class="resize-handle left"></div>
        <div class="resize-handle right"></div>
        <div class="resize-handle top-left"></div>
        <div class="resize-handle top-right"></div>
        <div class="resize-handle bottom-left"></div>
        <div class="resize-handle bottom-right"></div>
    </div>
    
    <div class="window" id="ebytorWindow" data-title="Ebytor" style="left: 100px; top: 100px; width: 800px; max-width: 95vw; min-width: 500px; min-height: 480px;">
        <div class="titlebar" data-drag>
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 18l4-4-4-4M8 6L4 10l4 4"/><path d="M10 20l4-16"/></svg>
            <div class="title">Ebytor</div>
            <div class="actions">
                <button class="btn small ghost" data-minimize title="Minimize">—</button>
                <button class="btn small ghost" data-maximize title="Maximize">◻</button>
                <button class="btn small ghost" data-close title="Close">✕</button>
            </div>
        </div>
        <div class="content ebytor-container">
            <div class="row" style="justify-content: flex-end;">
                <button class="btn" id="openEbytorFileBtn">Open</button>
                <button class="btn" id="saveEbytorFileBtn">Save</button>
                <button class="btn" id="runEbytorBtn">Run HTML</button>
            </div>
            <div class="editor-area">
                <div class="card">
                    <h3>HTML Code</h3>
                    <textarea id="ebytorCode"></textarea>
                </div>
                <div class="card">
                    <h3>Preview</h3>
                    <iframe id="ebytorPreview"></iframe>
                </div>
            </div>
        </div>
        <div class="resize-handle top"></div>
        <div class="resize-handle bottom"></div>
        <div class="resize-handle left"></div>
        <div class="resize-handle right"></div>
        <div class="resize-handle top-left"></div>
        <div class="resize-handle top-right"></div>
        <div class="resize-handle bottom-left"></div>
        <div class="resize-handle bottom-right"></div>
    </div>
    
    <div class="window" id="storeWindow" data-title="App Store" style="left: 280px; top: 180px; width: 480px; min-width: 420px; max-width: 90vw;">
        <div class="titlebar" data-drag><div class="title">App Store</div><div class="actions"><button class="btn small ghost" data-minimize title="Minimize">—</button><button class="btn small ghost" data-maximize title="Maximize">◻</button><button class="btn small ghost" data-close title="Close">✕</button></div></div>
        <div class="content">
            <div class="card">
                <h3>Aplikasi Tersedia</h3>
                <p class="muted" style="margin-bottom:12px;">Pilih aplikasi untuk diinstal.</p>
                <div id="storeApps"></div>
            </div>
        </div>
        <div class="resize-handle top"></div>
        <div class="resize-handle bottom"></div>
        <div class="resize-handle left"></div>
        <div class="resize-handle right"></div>
        <div class="resize-handle top-left"></div>
        <div class="resize-handle top-right"></div>
        <div class="resize-handle bottom-left"></div>
        <div class="resize-handle bottom-right"></div>
    </div>

    <div class="taskbar"><div class="tb-left"><button class="btn start" id="startBtn">◎ Start</button><button class="btn" id="openAdminBtn" title="Buka Admin Panel"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1l3 5 5 .5-3.6 3.4.9 5-5.3-2.7-5.3 2.7.9-5L4 6.5 9 6z"/></svg></button><button class="btn" id="openCmdBtn" title="Buka Command Prompt"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 17l6-6-6-6"/><path d="M12 19h8"/></svg></button><button class="btn" id="openExplorerBtn" title="Buka File Explorer"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h18v13H3z"/><path d="M3 7L6 4h6l3 3"/></svg></button></div><div class="tb-center"><div class="apps-area" id="tasks"></div></div><div class="tb-right"><div class="clock" id="clock"></div></div></div>

    <div id="shutdown-screen">
        <div class="shutdown-content">
            <h2>Shutdown Server</h2>
            <p>Untuk mengonfirmasi, masukkan kode unik yang ditampilkan di konsol.</p>
            <div class="shutdown-input-group">
                <input type="text" id="shutdownCodeInput" placeholder="Masukkan kode..." />
            </div>
            <p id="shutdown-msg" style="margin-top: 10px;"></p>
        </div>
    </div>
    
    <div class="context-menu" id="explorerContextMenu">
        <div class="context-item" data-action="open-with-displayer">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 19H7a2 2 0 01-2-2V7a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2z"/><circle cx="12" cy="12" r="3"/><path d="M22 2l-2 2m-8 8l-2-2M2 22l2-2"/></svg>
            <span>[📺] Open With Displayer</span>
        </div>
    </div>
    
    <div class="modal-overlay" id="fileModal">
        <div class="modal">
            <h3 id="modalTitle">Open File</h3>
            <div id="modal-file-list" style="max-height: 250px; overflow-y: auto;">
                </div>
            <div style="margin-top: 12px;">
                <label for="newFileName" id="fileNameLabel">File Name</label>
                <input type="text" id="newFileName" placeholder="file.html" />
            </div>
            <div class="row" style="margin-top: 16px;">
                <button class="btn" id="modalOkBtn" style="flex: 1;">OK</button>
                <button class="btn ghost" id="modalCancelBtn" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);

        const ADMIN_API_INFO = "/api/info";
        const ADMIN_API_FILES = "/api/files";
        const ADMIN_API_PREVIEW = "/api/preview_file";
        const ADMIN_API_CMD = "/api/cmd";
        const ADMIN_API_SHUTDOWN = "/api/shutdown";
        const ADMIN_API_MEDIA = "/api/media";
        const ADMIN_API_FILE_OPEN = "/api/file/open";
        const ADMIN_API_FILE_SAVE = "/api/file/save";

        let loggedInUser = null;
        let activeWindows = [];
        let zIndexCounter = 10;
        const wallpapers = {
            'default': `radial-gradient(1200px 700px at 70% -10%, #223 0%, #111 55%, #0a0c10 100%), var(--bg)`,
            'nature': `url('https://source.unsplash.com/random/1920x1080?nature')`,
            'abstract': `url('https://source.unsplash.com/random/1920x1080?abstract')`,
        };
        const CURRENT_VERSION = '1.0.0';
        const serverStartTime = new Date();
        const INSTALLED_APPS = {}; // { id: { name, icon, windowEl } }
        let currentExplorerPath = '';

        // Daftar aplikasi yang tersedia di store
        const STORE_APPS = [
            {
                id: 'clockApp',
                name: 'Clock',
                icon: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>`,
                desc: 'Jam analog dan timer.',
                windowId: 'clockWindow'
            },
            {
                id: 'displayerApp',
                name: 'Displayer',
                icon: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 19H7a2 2 0 01-2-2V7a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2z"/><circle cx="12" cy="12" r="3"/><path d="M22 2l-2 2m-8 8l-2-2M2 22l2-2"/></svg>`,
                desc: 'Pemutar media untuk audio/video/gambar.',
                windowId: 'displayerWindow'
            },
            {
                id: 'ebytorApp',
                name: 'Ebytor',
                icon: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 18l4-4-4-4M8 6L4 10l4 4"/><path d="M10 20l4-16"/></svg>`,
                desc: 'Editor & Runner untuk kode HTML.',
                windowId: 'ebytorWindow'
            }
        ];

        // --- Dragging Logic ---
        function attachDragListeners(win) {
            const bar = win.querySelector('[data-drag]');
            if (!bar) return;
            let sx, sy, sl, st, dragging = false;
            bar.addEventListener('mousedown', (e) => {
                if (e.target.closest('.actions')) return;
                dragging = true;
                bringToFront(win);
                sx = e.clientX;
                sy = e.clientY;
                sl = parseInt(win.style.left || '80', 10);
                st = parseInt(win.style.top || '80', 10);
                document.body.style.userSelect = 'none';
                win.classList.add('dragging');
            });
            document.addEventListener('mousemove', (e) => {
                if (!dragging) return;
                const nl = sl + (e.clientX - sx);
                const nt = st + (e.clientY - sy);
                win.style.left = Math.min(innerWidth-80, Math.max(-win.offsetWidth+80, nl)) + 'px';
                win.style.top = Math.min(innerHeight-120, Math.max(0, nt)) + 'px';
            });
            document.addEventListener('mouseup', () => {
                dragging = false;
                document.body.style.userSelect = '';
                win.classList.remove('dragging');
            });
        }
        
        // --- Resizing Logic ---
        function attachResizeListeners(win) {
            const handles = win.querySelectorAll('.resize-handle');
            handles.forEach(handle => {
                let resizing = false;
                let startX, startY, startWidth, startHeight, startLeft, startTop;
                
                handle.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    resizing = true;
                    bringToFront(win);
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = win.offsetWidth;
                    startHeight = win.offsetHeight;
                    startLeft = win.offsetLeft;
                    startTop = win.offsetTop;
                    document.body.style.userSelect = 'none';
                    document.body.style.cursor = handle.style.cursor;
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!resizing) return;
                    
                    let newWidth = startWidth;
                    let newHeight = startHeight;
                    let newLeft = startLeft;
                    let newTop = startTop;
                    
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;

                    if (handle.classList.contains('right')) {
                        newWidth = Math.max(win.style.minWidth ? parseInt(win.style.minWidth) : 100, startWidth + dx);
                    }
                    if (handle.classList.contains('bottom')) {
                        newHeight = Math.max(win.style.minHeight ? parseInt(win.style.minHeight) : 100, startHeight + dy);
                    }
                    if (handle.classList.contains('left')) {
                        newWidth = Math.max(win.style.minWidth ? parseInt(win.style.minWidth) : 100, startWidth - dx);
                        newLeft = startLeft + dx;
                    }
                    if (handle.classList.contains('top')) {
                        newHeight = Math.max(win.style.minHeight ? parseInt(win.style.minHeight) : 100, startHeight - dy);
                        newTop = startTop + dy;
                    }
                    
                    win.style.width = newWidth + 'px';
                    win.style.height = newHeight + 'px';
                    win.style.left = newLeft + 'px';
                    win.style.top = newTop + 'px';
                });
                
                document.addEventListener('mouseup', () => {
                    resizing = false;
                    document.body.style.userSelect = '';
                    document.body.style.cursor = 'default';
                });
            });
        }


        // --- Window Management ---
        function openWindow(win) {
            const isMinimized = win.classList.contains('minimized');
            
            // Bring to front and activate
            bringToFront(win);
            win.classList.add('active');
            win.classList.remove('minimized');
            
            // Create taskbar button if it doesn't exist
            let taskBtn = $(`[data-for="${win.id}"]`);
            if(!taskBtn){
                const title = win.dataset.title || win.querySelector('.title')?.textContent || win.id;
                taskBtn = createTaskButton(win.id, title);
                $('#tasks').appendChild(taskBtn);
                activeWindows.push(win);
            }
        }

        function closeWindow(win) {
            if (!win) return;
            win.classList.remove('active');
            win.classList.add('minimized');
            const index = activeWindows.indexOf(win);
            if (index > -1) {
                activeWindows.splice(index, 1);
            }
            const taskBtn = $(`[data-for="${win.id}"]`);
            if (taskBtn) taskBtn.remove();
        }

        function minimizeWindow(win) {
            if (!win) return;
            win.classList.remove('active');
            win.classList.add('minimized');
            updateTaskButtonState(win);
        }

        function maximizeWindow(win) {
            if (!win) return;
            const isMaximized = win.dataset.max === '1';
            
            if (isMaximized) {
                win.style.left = win.dataset.prevLeft || '80px';
                win.style.top = win.dataset.prevTop || '80px';
                win.style.width = win.dataset.prevWidth || '720px';
                win.style.height = win.dataset.prevHeight || 'auto';
                win.dataset.max = '0';
            } else {
                win.dataset.prevLeft = win.style.left;
                win.dataset.prevTop = win.style.top;
                win.dataset.prevWidth = win.style.width;
                win.dataset.prevHeight = win.style.height;
                win.style.left = '10px';
                win.style.top = '10px';
                win.style.width = (innerWidth - 20) + 'px';
                win.style.height = (innerHeight - 70) + 'px';
                win.dataset.max = '1';
            }
            bringToFront(win);
            updateTaskButtonState(win);
        }

        function bringToFront(win) {
            zIndexCounter++;
            win.style.zIndex = zIndexCounter;
            $$('.task.active').forEach(btn => btn.classList.remove('active'));
            const taskBtn = $(`[data-for="${win.id}"]`);
            if (taskBtn) taskBtn.classList.add('active');
        }

        function updateTaskButtonState(win) {
            const taskBtn = $(`[data-for="${win.id}"]`);
            if (taskBtn) {
                taskBtn.classList.toggle('active', win.classList.contains('active'));
            }
        }
        
        function createTaskButton(id, title) {
            const btn = document.createElement('div');
            btn.className = 'btn task';
            btn.dataset.for = id;
            btn.textContent = title;
            btn.addEventListener('click', () => {
                const win = $('#' + id);
                if (win) {
                    if (win.classList.contains('active')) {
                        minimizeWindow(win);
                    } else {
                        openWindow(win);
                    }
                }
            });
            return btn;
        }

        $$('.window').forEach(win => {
            attachDragListeners(win);
            attachResizeListeners(win);
            const closeBtn = win.querySelector('[data-close]');
            if (closeBtn) closeBtn.addEventListener('click', () => closeWindow(win));
            const minBtn = win.querySelector('[data-minimize]');
            if (minBtn) minBtn.addEventListener('click', () => minimizeWindow(win));
            const maxBtn = win.querySelector('[data-maximize]');
            if (maxBtn) maxBtn.addEventListener('click', () => maximizeWindow(win));
            win.addEventListener('mousedown', () => bringToFront(win));
        });

        // Event listeners untuk tombol-tombol utama
        $('#openAdminBtn').addEventListener('click', () => openWindow($('#adminWindow')));
        $('#openCmdBtn').addEventListener('click', () => openWindow($('#cmdWindow')));
        $('#openExplorerBtn').addEventListener('click', () => {
            openWindow($('#explorerWindow'));
            renderExplorer(currentExplorerPath); // Muat ulang direktori saat membuka
        });

        // Event listeners untuk menu Start
        $('#openAdminFromMenu').addEventListener('click', () => { openWindow($('#adminWindow')); startMenu.classList.remove('active'); });
        $('#openCmd').addEventListener('click', () => { openWindow($('#cmdWindow')); startMenu.classList.remove('active'); });
        $('#openExplorer').addEventListener('click', () => { openWindow($('#explorerWindow')); renderExplorer(currentExplorerPath); startMenu.classList.remove('active'); });
        $('#openMines').addEventListener('click', () => { openWindow($('#minesWindow')); startMenu.classList.remove('active'); });
        $('#openTetris').addEventListener('click', () => { openWindow($('#tetrisWindow')); startMenu.classList.remove('active'); });
        $('#openStoreFromMenu').addEventListener('click', () => { openWindow($('#storeWindow')); renderStore(); startMenu.classList.remove('active'); });
        
        // --- UI Logic ---
        const loginScreen = $('#login-screen');
        const loginForm = $('#loginForm');
        const loginError = $('#login-error');
        const desktop = $('#desktop');
        const taskbar = $('.taskbar');
        const tasks = $('#tasks');
        const shutdownBtn = $('#shutdownBtn');
        const shutdownScreen = $('#shutdown-screen');
        const shutdownInput = $('#shutdownCodeInput');
        const shutdownMsg = $('#shutdown-msg');

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = $('#username').value;
            const password = $('#password').value;
            if (username === 'admin' && password === '1234') {
                loggedInUser = username;
                $('#usernameDisplay').textContent = username;
                loginScreen.classList.add('hidden');
                desktop.classList.add('visible');
                taskbar.classList.add('visible');
                $('#rolePill').textContent = `role: ${username}`;
                $('#cmdPrompt').textContent = `C:\\Users\\${username}>`;
                openWindow($('#adminWindow'));
                log(`[auth] User '${username}' logged in successfully.`);
            } else {
                loginError.textContent = 'Username atau password salah.';
                setTimeout(() => loginError.textContent = '', 2000);
            }
        });

        $('#logoutBtn').addEventListener('click', () => {
            logout();
        });

        function logout() {
            loggedInUser = null;
            $$('.window.active, .window.minimized').forEach(win => closeWindow(win));
            desktop.classList.remove('visible');
            taskbar.classList.remove('visible');
            loginScreen.classList.remove('hidden');
            $('#tasks').innerHTML = '';
            $('#username').value = 'admin';
            $('#password').value = '1234';
            log('[auth] User logged out.');
        }

        const clockEl = $('#clock');
        const uptimeEl = $('#uptime');

        function updateClockAndUptime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID', { hour12: false });
            const dateString = now.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
            clockEl.textContent = `${dateString} | ${timeString}`;
            
            // Update uptime
            const uptimeInSeconds = Math.floor((now - serverStartTime) / 1000);
            const hours = Math.floor(uptimeInSeconds / 3600);
            const minutes = Math.floor((uptimeInSeconds % 3600) / 60);
            const seconds = uptimeInSeconds % 60;
            const formatTime = (t) => t.toString().padStart(2, '0');
            uptimeEl.textContent = `${formatTime(hours)}:${formatTime(minutes)}:${formatTime(seconds)}`;
        }

        setInterval(updateClockAndUptime, 1000);
        updateClockAndUptime();

        const startBtn = $('#startBtn');
        const startMenu = $('#startMenu');
        startBtn.addEventListener('click', ()=>{
            startMenu.classList.toggle('active');
        });
        document.addEventListener('click', (e)=>{
            if(!startMenu.contains(e.target) && e.target!==startBtn){
                startMenu.classList.remove('active');
            }
        });

        const userStore = [];
        function renderUsers() {
            const el = $('#userList');
            if(!el) return;
            el.innerHTML = '';
            userStore.forEach((u,i)=>{
                const row = document.createElement('div');
                row.className = 'row';
                row.innerHTML = `<div>@${u}</div><button class="btn small" data-del="${i}">Hapus</button>`;
                el.appendChild(row);
            });
            el.querySelectorAll('[data-del]').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    const idx = +btn.dataset.del;
                    userStore.splice(idx,1);
                    renderUsers();
                    log(`[users] delete ${userStore[idx] || 'user'}`);
                });
            });
        }
        
        $('#addUser').addEventListener('click', ()=>{
            const v = $('#newUser').value.trim();
            if(!v) return;
            if(userStore.includes(v)) return toast('User sudah ada');
            userStore.push(v);
            $('#newUser').value='';
            renderUsers();
            log(`[users] add ${v}`);
        });
        
        $('#clearUsers').addEventListener('click', ()=>{
            userStore.length = 0;
            renderUsers();
            log('[users] cleared');
        });

        function applyTheme(theme){
             if (theme === 'light') {
                document.body.classList.add('light-theme');
                document.body.style.background = `var(--bg)`;
            } else if (theme === 'amoled') {
                document.body.classList.remove('light-theme');
                document.body.style.background = '#000';
            } else {
                document.body.classList.remove('light-theme');
                document.body.style.background = `radial-gradient(1200px 700px at 70% -10%, #223 0%, #111 55%, #0a0c10 100%), var(--bg)`;
            }
        }
        
        function applyWallpaper(wallpaper) {
            desktop.style.backgroundImage = wallpapers[wallpaper] || '';
        }

        $('#saveSettings').addEventListener('click', ()=>{
            const theme = $('#themeSelect').value;
            const wallpaper = $('#wallpaperSelect').value;
            applyTheme(theme);
            applyWallpaper(wallpaper);
            toast('Pengaturan disimpan');
            log(`[settings] saved {theme:${theme}, wallpaper:${wallpaper}}`);
        });
        
        $('#resetSettings').addEventListener('click', ()=>{
            $('#siteName').value = 'My Awesome App';
            $('#adminPass').value = '';
            $('#themeSelect').value = 'dark';
            $('#wallpaperSelect').value = 'default';
            applyTheme('dark');
            applyWallpaper('default');
            toast('Pengaturan direset');
            log('[settings] reset');
        });

        // --- Fungsi Log & Toast ---
        function log(message){
            const logs = $('#logs');
            if(logs) {
                logs.value += `[${new Date().toLocaleTimeString()}] ${message}\n`;
                logs.scrollTop = logs.scrollHeight;
            }
        }
        function toast(message){
            const t = $('.toast');
            t.textContent = message;
            t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 2500);
        }

        // --- CMD FUNGSI BARU ---
        const cmdInput = $('#cmdInput');
        const cmdOutput = $('#cmdOutput');
        
        if (cmdInput) {
            cmdInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const cmd = cmdInput.value.trim();
                    appendCmdOutput(`\n${$('#cmdPrompt').textContent}${cmd}\n`);
                    cmdInput.value = '';
                    handleCmd(cmd.toLowerCase());
                }
            });
        }

        function appendCmdOutput(text) {
            cmdOutput.textContent += text;
            cmdOutput.scrollTop = cmdOutput.scrollHeight;
        }

        async function handleCmd(cmd) {
            let output;
            try {
                if (cmd === 'date' || cmd === 'time' || cmd === 'datetime') {
                    const response = await fetch(`${ADMIN_API_CMD}?cmd=${cmd}`);
                    const data = await response.text();
                    output = data;
                } else if (cmd === 'help') {
                    output = 'Daftar perintah:\n- date/time/datetime: Menampilkan tanggal dan waktu.\n- help: Menampilkan daftar perintah.\n- cls: Membersihkan layar.\n- user: Menampilkan pengguna saat ini.\n- exit: Menutup jendela CMD.\n';
                } else if (cmd === 'cls') {
                    cmdOutput.textContent = '';
                    return;
                } else if (cmd === 'user') {
                    output = `User saat ini: ${loggedInUser}\n`;
                } else if (cmd === 'exit') {
                    closeWindow($('#cmdWindow'));
                    return;
                } else {
                    output = `'${cmd}' tidak dikenali sebagai perintah.\nKetik 'help' untuk daftar perintah.\n`;
                }
            } catch (e) {
                output = `Error: Gagal menghubungi server.\n`;
                log(`[cmd] API error: ${e.message}`);
            }
            appendCmdOutput(output);
        }
        
        // --- FILE EXPLORER & DISPLAYER FUNGSI BARU ---
        async function getFiles(path = '') {
            const response = await fetch(`${ADMIN_API_FILES}?path=${encodeURIComponent(path)}`);
            if (!response.ok) {
                throw new Error('Gagal memuat data file.');
            }
            return await response.json();
        }

        async function renderExplorer(path = '') {
            const folderList = $('#folderList');
            const filePreview = $('#filePreview');
            folderList.innerHTML = '';
            filePreview.textContent = 'Pilih file untuk melihat isinya.';
            currentExplorerPath = path;
        
            try {
                const data = await getFiles(path);
        
                if (data.status === 'error') {
                    folderList.textContent = data.message;
                    log(`[explorer] Error: ${data.message}`);
                    return;
                }
        
                if (path !== '') {
                    const backEl = document.createElement('div');
                    backEl.className = 'file-item folder';
                    backEl.innerHTML = `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg><span>...</span>`;
                    backEl.addEventListener('click', () => {
                        const parentPath = path.substring(0, path.lastIndexOf('/'));
                        renderExplorer(parentPath);
                    });
                    folderList.appendChild(backEl);
                }
        
                data.files.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = `file-item ${item.is_dir ? 'folder' : 'file'}`;
                    const icon = item.is_dir 
                        ? `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h4l2 3h10a2 2 0 012 2z"/></svg>`
                        : `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>`;
                    itemEl.innerHTML = `${icon}<span>${item.name}</span>`;
                    itemEl.dataset.filename = item.name;
                    itemEl.dataset.isDir = item.is_dir;

                    if (item.is_dir) {
                        itemEl.addEventListener('click', () => {
                            const newPath = path ? `${path}/${item.name}` : item.name;
                            renderExplorer(newPath);
                        });
                    } else {
                        itemEl.addEventListener('click', () => {
                            previewFile(item.name, path);
                        });
                    }
                    folderList.appendChild(itemEl);
                });
            } catch (e) {
                folderList.textContent = `Error: ${e.message}`;
            }
        }
        
        async function previewFile(filename, path) {
            const filePreview = $('#filePreview');
            filePreview.textContent = 'Memuat konten file...';
            try {
                const fullPath = path ? `${path}/${filename}` : filename;
                const response = await fetch(`${ADMIN_API_PREVIEW}?path=${encodeURIComponent(fullPath)}`);
                if (!response.ok) {
                    throw new Error('Gagal memuat konten file.');
                }
                const content = await response.text();
                filePreview.textContent = content;
            } catch (e) {
                filePreview.textContent = `Error: ${e.message}`;
            }
        }
        
        async function renderDisplayerFiles() {
            const fileListEl = $('#mediaFileList');
            fileListEl.innerHTML = '';
            try {
                const data = await getFiles();
                if (data.status === 'error') {
                    fileListEl.textContent = data.message;
                    return;
                }
                data.files.forEach(file => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (['mp3', 'mp4', 'png', 'jpg', 'jpeg'].includes(ext)) {
                        const fileEl = document.createElement('div');
                        fileEl.className = 'btn small';
                        fileEl.textContent = file.name;
                        fileEl.addEventListener('click', () => {
                            displayMedia(file.name);
                        });
                        fileListEl.appendChild(fileEl);
                    }
                });
                if (fileListEl.children.length === 0) {
                    fileListEl.innerHTML = '<p class="muted">Tidak ada file media di direktori root.</p>';
                }
            } catch (e) {
                fileListEl.innerHTML = `<p class="muted">Gagal memuat file: ${e.message}</p>`;
            }
        }

        function displayMedia(filename) {
            const viewer = $('#mediaViewer');
            const ext = filename.split('.').pop().toLowerCase();
            const mediaUrl = `${ADMIN_API_MEDIA}?filename=${encodeURIComponent(filename)}`;
            viewer.innerHTML = '';

            if (['mp3'].includes(ext)) {
                const audio = document.createElement('audio');
                audio.src = mediaUrl;
                audio.controls = true;
                audio.autoplay = true;
                audio.style.width = '100%';
                viewer.appendChild(audio);
            } else if (['mp4'].includes(ext)) {
                const video = document.createElement('video');
                video.src = mediaUrl;
                video.controls = true;
                video.autoplay = true;
                video.style.maxWidth = '100%';
                video.style.maxHeight = '100%';
                video.style.objectFit = 'contain';
                viewer.appendChild(video);
            } else if (['png', 'jpg', 'jpeg'].includes(ext)) {
                const img = document.createElement('img');
                img.src = mediaUrl;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '100%';
                img.style.objectFit = 'contain';
                viewer.appendChild(img);
            } else {
                viewer.innerHTML = '<p class="muted">Format file tidak didukung.</p>';
            }
            log(`[displayer] Membuka file: ${filename}`);
            openWindow($('#displayerWindow'));
        }

        // --- NEW: Explorer Context Menu Logic ---
        const explorerContextMenu = $('#explorerContextMenu');
        let selectedFileElement = null;

        document.addEventListener('contextmenu', (e) => {
            const fileItem = e.target.closest('.file-item');
            if (fileItem && fileItem.closest('#explorerWindow')) {
                e.preventDefault();
                selectedFileElement = fileItem;
                const filename = fileItem.dataset.filename;
                const isDir = fileItem.dataset.isDir === 'true';

                // Hanya tampilkan menu jika itu adalah file media yang dapat dibuka
                const ext = filename.split('.').pop().toLowerCase();
                const isMediaFile = ['mp3', 'mp4', 'png', 'jpg', 'jpeg'].includes(ext);

                if (isMediaFile) {
                    explorerContextMenu.style.top = `${e.clientY}px`;
                    explorerContextMenu.style.left = `${e.clientX}px`;
                    explorerContextMenu.classList.add('active');
                } else {
                    explorerContextMenu.classList.remove('active');
                }
            } else {
                explorerContextMenu.classList.remove('active');
            }
        });

        document.addEventListener('click', (e) => {
            if (!explorerContextMenu.contains(e.target)) {
                explorerContextMenu.classList.remove('active');
            }
        });

        explorerContextMenu.querySelector('[data-action="open-with-displayer"]').addEventListener('click', () => {
            if (selectedFileElement) {
                const filename = selectedFileElement.dataset.filename;
                displayMedia(filename);
                explorerContextMenu.classList.remove('active');
            }
        });

        // --- MINI GAME LOGIC ---
        // Minesweeper
        const minesBoard = $('#minesBoard');
        const minesStatus = $('#minesStatus');
        const restartMinesBtn = $('#restartMines');
        const BOARD_SIZE = 9;
        const NUM_MINES = 10;
        let board;
        let revealedCells;
        let isGameOver;

        function createMinesBoard() {
            board = Array.from({ length: BOARD_SIZE }, () => Array(BOARD_SIZE).fill(0));
            revealedCells = Array.from({ length: BOARD_SIZE }, () => Array(BOARD_SIZE).fill(false));
            isGameOver = false;
            
            // Place mines
            let minesPlaced = 0;
            while (minesPlaced < NUM_MINES) {
                const row = Math.floor(Math.random() * BOARD_SIZE);
                const col = Math.floor(Math.random() * BOARD_SIZE);
                if (board[row][col] !== 'mine') {
                    board[row][col] = 'mine';
                    minesPlaced++;
                }
            }
            // Calculate numbers
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (board[r][c] === 'mine') continue;
                    let count = 0;
                    for (let dr = -1; dr <= 1; dr++) {
                        for (let dc = -1; dc <= 1; dc++) {
                            const nr = r + dr;
                            const nc = c + dc;
                            if (nr >= 0 && nr < BOARD_SIZE && nc >= 0 && nc < BOARD_SIZE && board[nr][nc] === 'mine') {
                                count++;
                            }
                        }
                    }
                    board[r][c] = count;
                }
            }
        }

        function renderMinesBoard() {
            minesBoard.innerHTML = '';
            minesBoard.style.gridTemplateColumns = `repeat(${BOARD_SIZE}, 1fr)`;
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'mines-cell';
                    cell.style.width = cell.style.height = '36px';
                    cell.style.display = 'flex';
                    cell.style.alignItems = 'center';
                    cell.style.justifyContent = 'center';
                    cell.style.backgroundColor = '#4a5568';
                    cell.style.cursor = 'pointer';
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.addEventListener('click', () => revealCell(r, c));
                    minesBoard.appendChild(cell);
                }
            }
        }

        function revealCell(row, col) {
            if (isGameOver || revealedCells[row][col]) return;
            const cell = minesBoard.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            if (board[row][col] === 'mine') {
                cell.style.backgroundColor = 'red';
                cell.textContent = '💣';
                minesStatus.textContent = 'Game Over!';
                isGameOver = true;
            } else {
                revealedCells[row][col] = true;
                cell.style.backgroundColor = '#9ca3af';
                if (board[row][col] > 0) {
                    cell.textContent = board[row][col];
                }
            }
        }
        
        restartMinesBtn.addEventListener('click', () => {
            minesStatus.textContent = 'Ready';
            createMinesBoard();
            renderMinesBoard();
        });

        // Tetris
        const tetrisCanvas = $('#tetrisCanvas');
        const tetrisCtx = tetrisCanvas.getContext('2d');
        const tetrisStatus = $('#tetrisStatus');
        const restartTetrisBtn = $('#restartTetris');
        const BLOCK_SIZE = 20;
        const COLS = 10;
        const ROWS = 20;
        let grid;
        let currentPiece;
        let nextPiece;
        let score;
        let gameOver;
        let dropCounter;
        let lastTime;

        function newGrid() {
            return Array.from({ length: ROWS }, () => Array(COLS).fill(0));
        }

        function newPiece() {
            const pieces = [
                [[1, 1, 1, 1]], // I
                [[1, 1], [1, 1]], // O
                [[0, 1, 0], [1, 1, 1]], // T
                [[1, 1, 0], [0, 1, 1]], // S
                [[0, 1, 1], [1, 1, 0]], // Z
                [[1, 0, 0], [1, 1, 1]], // J
                [[0, 0, 1], [1, 1, 1]], // L
            ];
            const type = Math.floor(Math.random() * pieces.length);
            return {
                shape: pieces[type],
                x: Math.floor(COLS / 2) - Math.floor(pieces[type][0].length / 2),
                y: 0
            };
        }

        function drawBlock(x, y, color) {
            tetrisCtx.fillStyle = color;
            tetrisCtx.fillRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
            tetrisCtx.strokeStyle = 'black';
            tetrisCtx.strokeRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
        }

        function draw() {
            tetrisCtx.clearRect(0, 0, tetrisCanvas.width, tetrisCanvas.height);
            // Draw grid
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (grid[r][c]) {
                        drawBlock(c, r, 'white');
                    }
                }
            }
            // Draw current piece
            currentPiece.shape.forEach((row, r) => {
                row.forEach((value, c) => {
                    if (value) {
                        drawBlock(currentPiece.x + c, currentPiece.y + r, 'lightblue');
                    }
                });
            });
        }
        
        function collides(piece, newX, newY) {
            for (let r = 0; r < piece.shape.length; r++) {
                for (let c = 0; c < piece.shape[r].length; c++) {
                    if (piece.shape[r][c] &&
                        (grid[newY + r] && grid[newY + r][newX + c]) !== 0) {
                        return true;
                    }
                }
            }
            return false;
        }

        function merge() {
            currentPiece.shape.forEach((row, r) => {
                row.forEach((value, c) => {
                    if (value) {
                        grid[currentPiece.y + r][currentPiece.x + c] = 1;
                    }
                });
            });
        }

        function clearLines() {
            let linesCleared = 0;
            for (let r = ROWS - 1; r >= 0; r--) {
                if (grid[r].every(value => value === 1)) {
                    grid.splice(r, 1);
                    grid.unshift(Array(COLS).fill(0));
                    linesCleared++;
                }
            }
            score += linesCleared;
        }

        function gameLoop(time = 0) {
            if (gameOver) return;
            const deltaTime = time - lastTime;
            lastTime = time;
            dropCounter += deltaTime;
            if (dropCounter > 1000) {
                dropPiece();
            }
            draw();
            requestAnimationFrame(gameLoop);
        }

        function dropPiece() {
            if (collides(currentPiece, currentPiece.x, currentPiece.y + 1)) {
                merge();
                clearLines();
                currentPiece = nextPiece;
                nextPiece = newPiece();
                if (collides(currentPiece, currentPiece.x, currentPiece.y)) {
                    gameOver = true;
                    tetrisStatus.textContent = 'Game Over! Score: ' + score;
                }
            } else {
                currentPiece.y++;
            }
            dropCounter = 0;
        }

        function rotatePiece() {
            const shape = currentPiece.shape;
            const newShape = shape[0].map((_, colIndex) => shape.map(row => row[colIndex]).reverse());
            currentPiece.shape = newShape;
            // Prevent rotation into walls
            if (collides(currentPiece, currentPiece.x, currentPiece.y)) {
                currentPiece.shape = shape; // Revert
            }
        }

        document.addEventListener('keydown', (e) => {
            if (gameOver) return;
            if (e.key === 'ArrowLeft') {
                if (!collides(currentPiece, currentPiece.x - 1, currentPiece.y)) {
                    currentPiece.x--;
                }
            } else if (e.key === 'ArrowRight') {
                if (!collides(currentPiece, currentPiece.x + 1, currentPiece.y)) {
                    currentPiece.x++;
                }
            } else if (e.key === 'ArrowDown') {
                dropPiece();
            } else if (e.key === 'ArrowUp') {
                rotatePiece();
            }
        });

        function resetTetris() {
            grid = newGrid();
            currentPiece = newPiece();
            nextPiece = newPiece();
            score = 0;
            gameOver = false;
            dropCounter = 0;
            lastTime = 0;
            tetrisStatus.textContent = 'Ready';
            gameLoop();
        }

        restartTetrisBtn.addEventListener('click', resetTetris);

        // Client-side Shutdown Logic
        let shutdownCode = null;
        shutdownBtn.addEventListener('click', async () => {
            const response = await fetch('/api/shutdown', {method: 'POST'});
            const data = await response.json();
            if (data.status === 'success') {
                shutdownScreen.classList.add('active');
                shutdownCode = data.code;
                console.log('Shutdown code:', data.code);
            } else {
                toast(data.message);
            }
        });

        shutdownInput.addEventListener('input', () => {
            if (shutdownInput.value === shutdownCode) {
                shutdownMsg.textContent = 'Kode benar! Server sedang dimatikan...';
                shutdownMsg.style.color = 'green';
                setTimeout(() => {
                    shutdownScreen.innerHTML = '<h2 class="final-message">Server Dimatikan</h2>';
                }, 2000);
            } else {
                shutdownMsg.textContent = 'Kode salah. Silakan coba lagi.';
                shutdownMsg.style.color = 'red';
            }
        });

        // --- NEW: Clock App Logic ---
        const clockCanvas = $('#analogClockCanvas');
        const clockCtx = clockCanvas.getContext('2d');
        const timerDisplay = $('#timerDisplay');
        const timerStartBtn = $('#timerStart');
        const timerPauseBtn = $('#timerPause');
        const timerResetBtn = $('#timerReset');
        const timerInput = $('#timerInput');

        let timerInterval;
        let timeLeft = 0;

        function drawClock() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            const radius = clockCanvas.width / 2;
            clockCtx.clearRect(0, 0, clockCanvas.width, clockCanvas.height);
            clockCtx.translate(radius, radius);

            // Circle
            clockCtx.beginPath();
            clockCtx.arc(0, 0, radius * 0.9, 0, 2 * Math.PI);
            clockCtx.fillStyle = 'rgba(255,255,255,.05)';
            clockCtx.fill();
            clockCtx.strokeStyle = 'rgba(255,255,255,.2)';
            clockCtx.lineWidth = 4;
            clockCtx.stroke();

            // Hands
            function drawHand(length, width, angle, color) {
                clockCtx.beginPath();
                clockCtx.moveTo(0, 0);
                clockCtx.rotate(angle);
                clockCtx.lineTo(0, -length);
                clockCtx.strokeStyle = color;
                clockCtx.lineWidth = width;
                clockCtx.lineCap = 'round';
                clockCtx.stroke();
                clockCtx.rotate(-angle);
            }

            // Seconds Hand
            const secAngle = (seconds / 60) * 2 * Math.PI - Math.PI / 2;
            drawHand(radius * 0.8, 2, secAngle, 'var(--accent)');

            // Minutes Hand
            const minAngle = (minutes / 60) * 2 * Math.PI - Math.PI / 2;
            drawHand(radius * 0.7, 4, minAngle, 'var(--text)');

            // Hours Hand
            const hourAngle = ((hours % 12) / 12) * 2 * Math.PI - Math.PI / 2 + (minutes / 60) * (2 * Math.PI / 12);
            drawHand(radius * 0.5, 6, hourAngle, 'var(--text)');

            // Reset translation
            clockCtx.translate(-radius, -radius);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const formatTime = (t) => t.toString().padStart(2, '0');
            timerDisplay.textContent = `${formatTime(minutes)}:${formatTime(seconds)}`;
        }

        timerStartBtn.addEventListener('click', () => {
            if (timerInterval) return;
            if (timeLeft === 0) {
                timeLeft = parseInt(timerInput.value, 10) || 0;
            }
            if (timeLeft <= 0) {
                toast('Masukkan durasi timer.');
                return;
            }
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    toast('Timer selesai!');
                }
            }, 1000);
            timerStartBtn.style.display = 'none';
            timerPauseBtn.style.display = 'inline-flex';
            log('[clock] Timer dimulai.');
        });

        timerPauseBtn.addEventListener('click', () => {
            clearInterval(timerInterval);
            timerInterval = null;
            timerStartBtn.style.display = 'inline-flex';
            timerPauseBtn.style.display = 'none';
            log('[clock] Timer dijeda.');
        });

        timerResetBtn.addEventListener('click', () => {
            clearInterval(timerInterval);
            timerInterval = null;
            timeLeft = 0;
            updateTimerDisplay();
            timerInput.value = '';
            timerStartBtn.style.display = 'inline-flex';
            timerPauseBtn.style.display = 'none';
            log('[clock] Timer direset.');
        });

        // Loop for analog clock
        setInterval(drawClock, 1000);
        drawClock();
        
        // --- NEW: App Store Logic ---
        function renderStore() {
            const storeAppsEl = $('#storeApps');
            if(!storeAppsEl) return;
            storeAppsEl.innerHTML = '';
            
            STORE_APPS.forEach(app => {
                const appItem = document.createElement('div');
                appItem.className = 'app-item';
                const installed = INSTALLED_APPS[app.id];
                const buttonText = installed ? 'Open' : 'Install';
                const buttonClass = installed ? '' : 'install';

                appItem.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        ${app.icon}
                        <div>
                            <div class="title">${app.name}</div>
                            <div class="desc">${app.desc}</div>
                        </div>
                    </div>
                    <button class="btn small ${buttonClass}" data-app-id="${app.id}">${buttonText}</button>
                `;
                storeAppsEl.appendChild(appItem);
            });

            storeAppsEl.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const appId = btn.dataset.appId;
                    const app = STORE_APPS.find(a => a.id === appId);
                    if (app) {
                        if (btn.textContent === 'Install') {
                            installApp(app);
                        }
                        openWindow($('#' + app.windowId));
                    }
                });
            });
        }
        
        function installApp(app) {
            INSTALLED_APPS[app.id] = true;
            renderInstalledAppsMenu();
            renderStore();
            toast(`${app.name} berhasil diinstal!`);
            log(`[store] ${app.name} installed.`);
        }
        
        function renderInstalledAppsMenu() {
            const menu = $('#installedAppsMenu');
            menu.innerHTML = '';
            STORE_APPS.forEach(app => {
                if (INSTALLED_APPS[app.id]) {
                    const item = document.createElement('div');
                    item.className = 'menu-item';
                    item.innerHTML = `${app.icon}<div><div class="title">${app.name}</div><div class="desc">Jalankan aplikasi</div></div>`;
                    item.addEventListener('click', () => {
                        openWindow($('#' + app.windowId));
                        startMenu.classList.remove('active');
                    });
                    menu.appendChild(item);
                }
            });
            if(menu.innerHTML.trim() !== ''){
                const divider = document.createElement('div');
                divider.className = 'divider';
                menu.prepend(divider);
            }
        }

        // --- NEW: Ebytor App Logic ---
        const ebytorCodeEl = $('#ebytorCode');
        const ebytorPreviewEl = $('#ebytorPreview');
        const runEbytorBtn = $('#runEbytorBtn');
        const openEbytorFileBtn = $('#openEbytorFileBtn');
        const saveEbytorFileBtn = $('#saveEbytorFileBtn');

        runEbytorBtn.addEventListener('click', () => {
            const htmlCode = ebytorCodeEl.value;
            const doc = ebytorPreviewEl.contentWindow.document;
            doc.open();
            doc.write(htmlCode);
            doc.close();
            log('[ebytor] Code run in preview.');
        });
        
        openEbytorFileBtn.addEventListener('click', () => {
            openFileModal('open');
        });
        
        saveEbytorFileBtn.addEventListener('click', () => {
            openFileModal('save');
        });

        // Initial content for Ebytor
        ebytorCodeEl.value = `<!DOCTYPE html>
<html>
<head>
    <title>Hello MIOS!</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f0f0;
            color: #333;
            padding: 20px;
        }
        h1 {
            color: #5b9cff;
        }
    </style>
</head>
<body>
    <h1>Selamat datang di Ebytor!</h1>
    <p>Silakan tulis kode HTML Anda di sini dan klik tombol "Run HTML" untuk melihat hasilnya.</p>
</body>
</html>
`;

        // --- NEW: File Modal Logic (untuk Ebytor) ---
        const fileModal = $('#fileModal');
        const modalTitle = $('#modalTitle');
        const modalFileList = $('#modal-file-list');
        const newFileNameInput = $('#newFileName');
        const modalOkBtn = $('#modalOkBtn');
        const modalCancelBtn = $('#modalCancelBtn');

        let currentModalMode = ''; // 'open' or 'save'

        function openFileModal(mode) {
            currentModalMode = mode;
            modalTitle.textContent = mode === 'open' ? 'Open File' : 'Save File';
            newFileNameInput.placeholder = mode === 'open' ? 'Pilih file...' : 'Nama file...';
            newFileNameInput.value = '';
            renderModalFileList();
            fileModal.classList.add('active');
        }

        modalCancelBtn.addEventListener('click', () => {
            fileModal.classList.remove('active');
        });
        fileModal.addEventListener('click', (e) => {
            if (e.target === fileModal) {
                fileModal.classList.remove('active');
            }
        });
        
        async function renderModalFileList() {
            modalFileList.innerHTML = '<p class="muted">Memuat file...</p>';
            try {
                const data = await getFiles();
                if (data.status === 'error') {
                    modalFileList.innerHTML = `<p class="muted">Gagal memuat file: ${data.message}</p>`;
                    return;
                }
                modalFileList.innerHTML = '';
                data.files.forEach(file => {
                    if (file.is_dir) return; // Hanya tampilkan file
                    
                    const fileEl = document.createElement('div');
                    fileEl.className = 'file-item file';
                    fileEl.innerHTML = `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg><span>${file.name}</span>`;
                    fileEl.addEventListener('click', () => {
                        newFileNameInput.value = file.name;
                    });
                    modalFileList.appendChild(fileEl);
                });
            } catch (e) {
                modalFileList.innerHTML = `<p class="muted">Gagal memuat file: ${e.message}</p>`;
            }
        }
        
        modalOkBtn.addEventListener('click', async () => {
            const filename = newFileNameInput.value.trim();
            if (!filename) {
                toast('Nama file tidak boleh kosong.');
                return;
            }
            
            if (currentModalMode === 'open') {
                try {
                    const response = await fetch(`${ADMIN_API_FILE_OPEN}?path=${encodeURIComponent(filename)}`);
                    const data = await response.json();
                    if (data.status === 'success') {
                        ebytorCodeEl.value = data.content;
                        runEbytorBtn.click(); // Run immediately after opening
                        toast(`File '${filename}' berhasil dibuka.`);
                        log(`[ebytor] Opened file '${filename}'.`);
                    } else {
                        toast(`Gagal membuka file: ${data.message}`);
                    }
                } catch (e) {
                    toast(`Error: ${e.message}`);
                }
            } else if (currentModalMode === 'save') {
                try {
                    const content = ebytorCodeEl.value;
                    const response = await fetch(ADMIN_API_FILE_SAVE, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename, content })
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        toast(`File '${filename}' berhasil disimpan.`);
                        log(`[ebytor] Saved file '${filename}'.`);
                    } else {
                        toast(`Gagal menyimpan file: ${data.message}`);
                    }
                } catch (e) {
                    toast(`Error: ${e.message}`);
                }
            }
            fileModal.classList.remove('active');
        });

        // Initial setup
        renderStore();
        
        // Tab system for Admin Panel
        const tabList = $('#adminWindow .tabs');
        tabList.addEventListener('click', (e) => {
            const target = e.target.closest('.tab');
            if (!target) return;
            
            const tabId = target.dataset.tab;
            
            // Remove active class from all tabs
            $$('#adminWindow .tab').forEach(t => t.classList.remove('active'));
            // Hide all tab panels
            $$('#adminWindow .tab-panel').forEach(p => p.classList.remove('active'));
            
            // Add active class to clicked tab
            target.classList.add('active');
            // Show the corresponding tab panel
            $('#tab-' + tabId).classList.add('active');
        });

    </script>
</body>
</html>
